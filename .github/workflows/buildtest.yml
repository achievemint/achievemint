name: Build and Test Application

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build_test:
    runs-on: ubuntu-latest
    name: Build
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: lint
        run: npm run lint
      - name: test
        run: npm test
      - name: build
        run: npm run build

  cypress:
    name: Cypress ${{ matrix.test-type }}
    runs-on: ubuntu-latest
    needs: build_test

    strategy:
      fail-fast: false
      matrix:
        # Run e2e and component tests in parallel
        test-type: [ 'e2e', 'component' ]

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: build
        run: npm run build
      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          install: false
          # Run e2e tests with start-server-and-test
          start: npm run start -- -p 3472
          wait-on: 'http://localhost:3472'
          component: ${{ matrix.test-type == 'component' }}
          browser: chrome
          headed: false
        env:
          NEXTAUTH_SECRET: "BLAHHHHH"
          NEXTAUTH_URL: "http://172.17.0.1:3471"
          STEAM_SECRET: "TOP"

      # Upload screenshots when tests fail
      - name: Upload Cypress screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-${{ matrix.test-type }}
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 7

  screenshot_testing:
    runs-on: ubuntu-latest
    needs: build_test
    name: Lost Pixel

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: build
        run: npm run build
      - name: Start server (in background)
        run: npm run prod &
        env:
          NEXTAUTH_SECRET: "BLAHHHHH"
          NEXTAUTH_URL: "http://172.17.0.1:3471"
          STEAM_SECRET: "TOP"

      - name: Lost Pixel
        uses: lost-pixel/lost-pixel@v3.16.0
        env:
          LOST_PIXEL_API_KEY: ${{ secrets.LOST_PIXEL_API_KEY }}
